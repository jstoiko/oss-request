@*
 * Copyright (c) Salesforce.com, inc. 2017
 *@

@this()

@(newOrExistingTask: Either[(String, models.Task.Prototype), models.Task], groups: Map[String, Set[String]])

@taskPrototype = @{
    newOrExistingTask match {
        case Left((_, taskPrototype)) => taskPrototype
        case Right(task) => task.prototype
    }
}

@maybeCompletableBy = @{
    newOrExistingTask match {
        case Left((_, taskPrototype)) =>
            taskPrototype.completableBy.flatMap { completableBy =>
                completableBy.value.map { completableByValue =>
                    completableBy.`type` -> completableByValue
                }
            }
        case Right(task) =>
            Some(task.completableByType -> task.completableByValue)
    }
}

@assignedTo = {
    @for((completableByType, completableByValue) <- maybeCompletableBy) {
        @completableByType match {
            case models.Task.CompletableByType.Group => {
                Assigned to any of: @groups(completableByValue).mkString(", ")
            }
            case models.Task.CompletableByType.Email => {
                Assigned to: @completableByValue
            }
        }

    }
}

@formUrl(state: models.State.State = State.Completed) = @{
    newOrExistingTask match {
        case Left((name, _)) => routes.Application.newRequest(Some(name)).url
        case Right(task) => routes.Application.updateTask(task.id, state).url
    }
}

@taskPrototype.info

@(taskPrototype.`type`) match {
    case models.Task.TaskType.Input => {
        @defining(scala.util.Random.alphanumeric.take(8).mkString) { formid =>
            @for(form <- taskPrototype.form) {
                <div id="@formid"></div>
                <script>
                    (function() {
                        const form = @Html(form.toString());

                        form.options.form = {
                            attributes: {
                                action: "@Html(formUrl())",
                                method: "post"
                            },
                            buttons: {
                                submit: {
                                    click: function () {
                                        if (this.isValid(true)) {
                                            const config = {
                                                data: JSON.stringify(this.getValue()),
                                                contentType: "application/json"
                                            };
                                            this.ajaxSubmit(config).done(function(data) {
                                                if (data.requestId !== undefined) {
                                                    window.location = "/request?id=" + data.requestId;
                                                }
                                                else {
                                                    window.location = "/request?id=" + data.id;
                                                }
                                            });
                                        }
                                        else {
                                            console.error(this.getValue());
                                        }
                                    }
                                }
                            }
                        };

                        $("#@formid").alpaca(form);
                    })();
                </script>
            }
        }
    }
    case models.Task.TaskType.Action => {
        Action Required:

        @taskPrototype.label

        @taskPrototype.info

        @assignedTo

        <form action="@formUrl()" method="post">
            <button>Mark as Completed</button>
        </form>
    }
    case models.Task.TaskType.Approval => {
        Approval Required:

        @taskPrototype.label

        @taskPrototype.info

        @assignedTo

        <form action="@formUrl()" method="post">
            <button>Approve</button>
        </form>
        <form action="@formUrl(models.State.Cancelled)" method="post">
            <button>Deny</button>
        </form>
    }
}
